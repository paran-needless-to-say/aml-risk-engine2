<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÏïîÌò∏ÌôîÌèê Ï£ºÏÜå Î¶¨Ïä§ÌÅ¨ Î∂ÑÏÑù - Í∑∏ÎûòÌîÑ ÏãúÍ∞ÅÌôî</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f5f5;
        height: 100vh;
        overflow: hidden;
      }

      .top-bar {
        background: white;
        padding: 15px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
      }

      .search-section {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .search-input {
        flex: 1;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
      }

      .search-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .search-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }

      .search-btn:hover {
        background: #5568d3;
      }

      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .toolbar-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        border-radius: 4px;
        color: #666;
      }

      .toolbar-btn:hover {
        background: #f0f0f0;
      }

      .main-container {
        display: flex;
        height: calc(100vh - 60px);
      }

      .graph-container {
        flex: 1;
        background: white;
        position: relative;
      }

      #graph-network {
        width: 100%;
        height: 100%;
      }

      .info-panel {
        width: 500px;
        background: white;
        border-left: 1px solid #e0e0e0;
        overflow-y: auto;
        padding: 24px;
        font-size: 14px;
      }

      .info-panel.hidden {
        display: none;
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .info-header h2 {
        font-size: 18px;
        color: #333;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .close-btn:hover {
        color: #333;
      }

      .address-display {
        font-family: "Courier New", monospace;
        font-size: 14px;
        color: #667eea;
        margin-bottom: 15px;
        word-break: break-all;
      }

      .risk-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 15px;
      }

      .risk-badge.low {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .risk-badge.medium {
        background: #fff3e0;
        color: #e65100;
      }

      .risk-badge.high {
        background: #fce4ec;
        color: #c2185b;
      }

      .risk-badge.critical {
        background: #ffebee;
        color: #c62828;
      }

      .info-section {
        margin-bottom: 20px;
      }

      .info-section h3 {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
        text-transform: uppercase;
      }

      .info-value {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }

      .info-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
      }

      .info-item label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      .info-item .value {
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }

      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .tag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
      }

      .rules-list {
        margin-top: 15px;
      }

      .rule-item {
        padding: 8px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 6px;
        font-size: 13px;
      }

      .rule-item .rule-id {
        color: #667eea;
        font-weight: 600;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .loading-overlay.active {
        display: flex;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #999;
      }

      .empty-state h2 {
        margin-bottom: 10px;
        color: #666;
      }

      .example-links {
        margin-top: 20px;
        font-size: 14px;
      }

      .example-links a {
        color: #667eea;
        text-decoration: underline;
        cursor: pointer;
        margin: 0 5px;
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="search-section">
        <input
          type="text"
          class="search-input"
          id="addressInput"
          placeholder="Address, transaction"
        />
        <input
          type="text"
          class="search-input"
          id="etherscanApiKey"
          placeholder="Etherscan API Key (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
          value="91FZVKNIX7GYPESECU5PHPZIMKD72REX43"
          style="width: 200px"
        />
        <button class="search-btn" onclick="analyzeAddress()">Í≤ÄÏÉâ</button>
      </div>
      <div class="toolbar">
        <div class="hop-controls">
          <span style="font-size: 12px; color: #666; margin-right: 5px"
            >ÌôïÏû•:</span
          >
          <button
            class="hop-btn active"
            id="hop0Btn"
            title="Î©îÏù∏ ÎÖ∏ÎìúÎßå ÌëúÏãú"
            onclick="expandToHop(0)"
          >
            Î©îÏù∏
          </button>
          <button
            class="hop-btn"
            id="hop1Btn"
            title="1-hopÍπåÏßÄ ÌôïÏû•"
            onclick="expandToHop(1)"
          >
            1-hop
          </button>
          <button
            class="hop-btn"
            id="hop2Btn"
            title="2-hopÍπåÏßÄ ÌôïÏû•"
            onclick="expandToHop(2)"
          >
            2-hop
          </button>
          <button
            class="hop-btn"
            id="hop3Btn"
            title="3-hopÍπåÏßÄ ÌôïÏû•"
            onclick="expandToHop(3)"
          >
            3-hop
          </button>
        </div>
        <button class="toolbar-btn" title="ÏÉàÎ°úÍ≥†Ïπ®" onclick="resetGraph()">
          üîÑ
        </button>
        <button class="toolbar-btn" title="Ï§å Ïù∏" onclick="zoomIn()">‚ûï</button>
        <button class="toolbar-btn" title="Ï§å ÏïÑÏõÉ" onclick="zoomOut()">
          ‚ûñ
        </button>
        <button class="toolbar-btn" title="ÏÑ§Ï†ï" onclick="showSettings()">
          ‚öôÔ∏è
        </button>
      </div>
    </div>

    <div class="main-container">
      <div class="graph-container">
        <div id="graph-network"></div>
        <div class="loading-overlay" id="loadingOverlay">
          <div class="spinner"></div>
        </div>
        <div class="empty-state" id="emptyState">
          <h2>Ï£ºÏÜåÎ•º Í≤ÄÏÉâÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî</h2>
          <p>Ethereum Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÍ≥† Í≤ÄÏÉâ Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
          <div class="example-links">
            ÏòàÏãú: <a onclick="fillExample()">address</a> /
            <a onclick="fillExample()">transaction</a>
          </div>
        </div>
      </div>
      <div class="info-panel" id="infoPanel">
        <div
          class="info-header"
          style="
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
          "
        >
          <h2
            id="infoTitle"
            style="font-size: 18px; font-weight: 600; margin: 0"
          >
            Ï£ºÏÜå Ï†ïÎ≥¥
          </h2>
          <button
            class="close-btn"
            onclick="closeInfoPanel()"
            style="font-size: 24px; line-height: 1"
          >
            √ó
          </button>
        </div>
        <div id="infoContent" style="line-height: 1.6">
          <!-- ÎèôÏ†ÅÏúºÎ°ú Ï±ÑÏõåÏßê -->
        </div>
        <div id="transactionsList" style="margin-top: 20px; display: none">
          <h3 style="font-size: 14px; margin-bottom: 10px; color: #666">
            Í±∞Îûò Î™©Î°ù
          </h3>
          <div
            id="transactionsTable"
            style="max-height: 300px; overflow-y: auto"
          >
            <!-- Í±∞Îûò Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê® -->
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;
      let network = null;
      let nodes = null;
      let edges = null;
      let currentData = null;

      // Í∑∏ÎûòÌîÑ Ï¥àÍ∏∞Ìôî
      function initGraph() {
        const container = document.getElementById("graph-network");
        nodes = new vis.DataSet([]);
        edges = new vis.DataSet([]);

        const data = {
          nodes: nodes,
          edges: edges,
        };

        const options = {
          nodes: {
            shape: "dot",
            size: 20,
            font: {
              size: 12,
              color: "#333",
              face: "Arial",
            },
            borderWidth: 2,
            shadow: false, // Í∑∏Î¶ºÏûê Ï†úÍ±∞ (Îçî ÍπîÎÅîÌïòÍ≤å)
            chosen: {
              node: function (values, id, selected, hovering) {
                values.size = 35; // ÏÑ†ÌÉù Ïãú ÌÅ¨Í∏∞ Ï¶ùÍ∞Ä
              },
            },
          },
          edges: {
            width: 2,
            color: { color: "#4CAF50" }, // Ï¥àÎ°ùÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω (Pathfinder Ïä§ÌÉÄÏùº)
            arrows: {
              to: {
                enabled: true,
                scaleFactor: 0.6,
                type: "arrow",
              },
            },
            smooth: {
              type: "straightCross", // ÏßÅÏÑ†ÏúºÎ°ú Î≥ÄÍ≤Ω (Îçî ÍπîÎÅî)
              roundness: 0,
            },
            font: {
              size: 9,
              align: "middle",
              color: "#333",
            },
          },
          physics: {
            enabled: true,
            stabilization: {
              iterations: 200,
            },
            barnesHut: {
              gravitationalConstant: -2000,
              centralGravity: 0.1,
              springLength: 200,
              springConstant: 0.04,
              damping: 0.09,
            },
          },
          interaction: {
            hover: true,
            tooltipDelay: 200,
            zoomView: true,
            dragView: true,
          },
        };

        network = new vis.Network(container, data, options);

        // ÎÖ∏Îìú/Ïó£ÏßÄ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        network.on("click", function (params) {
          // Ïó£ÏßÄ ÌÅ¥Î¶≠Ïù¥ Ïö∞ÏÑ†
          if (params.edges.length > 0) {
            const edgeId = params.edges[0];
            showEdgeInfo(edgeId);
          } else if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];

            // ÎçîÎ∏î ÌÅ¥Î¶≠ Í∞êÏßÄ (ÌôïÏû•/Ï∂ïÏÜå)
            if (params.event && params.event.detail === 2) {
              toggleNodeExpansion(nodeId);
            } else {
              // Îã®Ïùº ÌÅ¥Î¶≠: Ï†ïÎ≥¥ ÌëúÏãú
              showNodeInfo(nodeId);
            }
          } else {
            closeInfoPanel();
          }
        });
      }

      // Ï£ºÏÜå Î∂ÑÏÑù
      async function analyzeAddress() {
        const address = document.getElementById("addressInput").value.trim();
        if (!address) {
          alert("Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
          return;
        }

        document.getElementById("loadingOverlay").classList.add("active");
        document.getElementById("emptyState").style.display = "none";

        try {
          // API Ìò∏Ï∂ú
          // Î†àÍ±∞Ïãú Îç∞Ïù¥ÌÑ∞ ÏûêÎèô Î°úÎìú + Etherscan API ÏÇ¨Ïö© (ÏÑ†ÌÉùÏ†Å)
          const response = await fetch(`${API_BASE}/api/analyze/address/demo`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              address: address,
              chain: "ethereum",
              transactions: [], // Îπà Î∞∞Ïó¥Ïù¥Î©¥ ÏûêÎèôÏúºÎ°ú Î†àÍ±∞Ïãú Îç∞Ïù¥ÌÑ∞ ÎòêÎäî EtherscanÏóêÏÑú Î°úÎìú
              analysis_type: "advanced",
              use_etherscan: !!document
                .getElementById("etherscanApiKey")
                .value.trim(), // API ÌÇ§Í∞Ä ÏûàÏùÑ ÎïåÎßå ÌôúÏÑ±Ìôî
              etherscan_api_key:
                document.getElementById("etherscanApiKey").value.trim() ||
                undefined,
              max_hops: document.getElementById("etherscanApiKey").value.trim()
                ? 3
                : 1, // API ÌÇ§ ÏûàÏúºÎ©¥ 3-hop, ÏóÜÏúºÎ©¥ 1-hop
            }),
          });

          const data = await response.json();

          if (data.error) {
            console.error("‚ùå API ÏóêÎü¨:", data.error);
            alert("Î∂ÑÏÑù Ïã§Ìå®: " + data.error);
            return;
          }

          console.log("‚úÖ Î∂ÑÏÑù ÏÑ±Í≥µ:", {
            address: data.target_address,
            risk_score: data.risk_score,
            nodes: data.graph?.nodes?.length || 0,
            edges: data.graph?.edges?.length || 0,
          });

          currentData = data;

          // Ï¥àÍ∏∞ ÏÉÅÌÉú: Î©îÏù∏ ÎÖ∏ÎìúÎßå ÌëúÏãú
          currentMaxHop = 0;
          expandedNodes.clear();

          // Hop Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
          document
            .querySelectorAll(".hop-btn")
            .forEach((btn) => btn.classList.remove("active"));
          const hop0Btn = document.getElementById("hop0Btn");
          if (hop0Btn) hop0Btn.classList.add("active");

          // Í∑∏ÎûòÌîÑ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
          buildGraphFromData(address, data);

          // Î©îÏù∏ ÎÖ∏Îìú Ï†ïÎ≥¥ ÌëúÏãú
          showNodeInfo(address);

          // Í±∞Îûò Î™©Î°ù ÌëúÏãú
          if (data.transactions && data.transactions.length > 0) {
            showTransactionsList(data.transactions);
          }
        } catch (error) {
          alert("Ïò§Î•ò Î∞úÏÉù: " + error.message);
        } finally {
          document.getElementById("loadingOverlay").classList.remove("active");
        }
      }

      // ÌôïÏû• Í∞ÄÎä•Ìïú ÎÖ∏Îìú ÏÉÅÌÉú Í¥ÄÎ¶¨
      const expandedNodes = new Set();
      const nodeHopMap = new Map(); // ÎÖ∏ÎìúÎ≥Ñ hop Ï†ïÎ≥¥
      let currentMaxHop = 0; // ÌòÑÏû¨ ÌëúÏãúÎêòÎäî ÏµúÎåÄ hop (0 = Î©îÏù∏ ÎÖ∏ÎìúÎßå)

      // Îç∞Ïù¥ÌÑ∞Î°úÎ∂ÄÌÑ∞ Í∑∏ÎûòÌîÑ ÏÉùÏÑ±
      function buildGraphFromData(mainAddress, data) {
        const graphNodes = [];
        const graphEdges = [];

        // APIÏóêÏÑú Î∞õÏùÄ Í∑∏ÎûòÌîÑ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
        const graphData = data.graph || { nodes: [], edges: [] };

        // ÎÖ∏Îìú hop Ï†ïÎ≥¥ Ï†ÄÏû•
        nodeHopMap.clear();
        graphData.nodes.forEach((node) => {
          nodeHopMap.set(node.id.toLowerCase(), node.hop || 0);
        });

        // Î©îÏù∏ Ï£ºÏÜå ÎÖ∏Îìú
        const riskLevel = data.risk_level || "low";
        const riskColors = {
          low: "#4caf50",
          medium: "#ff9800",
          high: "#f44336",
          critical: "#d32f2f",
        };

        const mainAddressLower = mainAddress.toLowerCase();

        // Î∞±ÏóîÎìúÏóêÏÑú Ï†ÑÎã¨Îêú Î©îÏù∏ ÎÖ∏Îìú Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ (graphDataÎäî ÏúÑÏóêÏÑú Ïù¥ÎØ∏ Ï†ïÏùòÎê®)
        const mainNodeData =
          graphData.nodes.find(
            (n) => n.id && n.id.toLowerCase() === mainAddressLower
          ) || {};

        // Î∞±ÏóîÎìúÏóêÏÑú Ïù¥ÎØ∏ ÎùºÎ≤®Ïù¥ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏúºÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í
        const mainLabel =
          mainNodeData.label || mainAddress.substring(0, 10) + "...";
        const mainTitle =
          mainNodeData.title ||
          mainAddress + "\nRisk Score: " + data.risk_score + "\nHop: 0 (Main)";

        console.log("üîç Î©îÏù∏ ÎÖ∏Îìú Îç∞Ïù¥ÌÑ∞:", {
          mainNodeData,
          mainLabel,
          entityName: mainNodeData.entity_name,
          addressStats: data.address_stats,
        });

        graphNodes.push({
          id: mainAddressLower,
          label: mainLabel, // Î∞±ÏóîÎìúÏóêÏÑú ÏÑ§Ï†ïÌïú ÎùºÎ≤® ÏÇ¨Ïö©
          title: mainTitle,
          color: {
            background: riskColors[riskLevel] || "#4caf50",
            border: "#333",
            highlight: {
              background: riskColors[riskLevel] || "#4caf50",
              border: "#000",
            },
          },
          size: 35,
          font: { size: 13, bold: true },
          shape: "dot",
          hop: 0,
          expanded: true, // Î©îÏù∏ ÎÖ∏ÎìúÎäî Ìï≠ÏÉÅ ÌôïÏû•Îê®
        });

        // APIÏóêÏÑú Î∞õÏùÄ Í∑∏ÎûòÌîÑ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (ÏûàÎäî Í≤ΩÏö∞)
        // graphDataÎäî ÏúÑÏóêÏÑú Ïù¥ÎØ∏ Ï†ïÏùòÎê®
        if (graphData.nodes) {
          graphData.nodes.forEach((node) => {
            const nodeId = node.id.toLowerCase();
            if (nodeId === mainAddressLower) {
              return; // Î©îÏù∏ ÎÖ∏ÎìúÎäî Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎê®
            }

            const nodeType = node.type || "address";
            const hop = node.hop || 1;

            // ÌòÑÏû¨ ÏÑ§Ï†ïÎêú ÏµúÎåÄ hopÍπåÏßÄÎßå ÌëúÏãú (Í∏∞Î≥∏: 0 = Î©îÏù∏ ÎÖ∏ÎìúÎßå)
            const isVisible = hop <= currentMaxHop || expandedNodes.has(nodeId);

            if (!isVisible) {
              return; // ÏïÑÏßÅ ÌôïÏû•ÎêòÏßÄ ÏïäÏùÄ ÎÖ∏ÎìúÎäî ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            }

            let nodeConfig = {
              id: nodeId,
              label:
                node.label || node.address || nodeId.substring(0, 8) + "..",
              title: node.title || (node.address || nodeId) + `\nHop: ${hop}`,
              size:
                node.size ||
                (nodeType === "rule" ? 15 : nodeType === "tag" ? 12 : 20), // ÌÅ¨Í∏∞ ÌÜµÏùº
              shape:
                nodeType === "rule"
                  ? "diamond"
                  : nodeType === "tag"
                  ? "box"
                  : "dot",
              hop: hop,
              expanded: expandedNodes.has(nodeId),
            };

            if (nodeType === "rule") {
              nodeConfig.color = { background: "#667eea", border: "#333" };
              nodeConfig.title = `Rule: ${node.label}\nScore: ${
                node.score || 0
              }`;
            } else if (nodeType === "tag") {
              nodeConfig.color = { background: "#ff9800", border: "#333" };
              nodeConfig.title = `Risk Tag: ${node.label}`;
            } else if (nodeType === "main_address") {
              // Î©îÏù∏ Ï£ºÏÜåÎäî Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎê®
              return;
            } else {
              // hopÏóê Îî∞Îùº ÏÉâÏÉÅ Ï°∞Ï†ï
              const hopColors = {
                1: "#e0e0e0",
                2: "#d0d0d0",
                3: "#c0c0c0",
              };
              nodeConfig.color = {
                background: hopColors[hop] || "#b0b0b0",
                border: "#333",
              };
            }

            graphNodes.push(nodeConfig);
          });
        }

        // Ïó£ÏßÄ Ï∂îÍ∞Ä (ÏñëÏ™Ω ÎÖ∏ÎìúÍ∞Ä Î™®Îëê ÌëúÏãúÎêòÎäî Í≤ΩÏö∞Îßå)
        if (graphData.edges) {
          const visibleNodeIds = new Set(graphNodes.map((n) => n.id));

          graphData.edges.forEach((edge) => {
            const fromId = edge.from.toLowerCase();
            const toId = edge.to.toLowerCase();

            // ÏñëÏ™Ω ÎÖ∏ÎìúÍ∞Ä Î™®Îëê ÌëúÏãúÎêòÎäî Í≤ΩÏö∞Îßå Ïó£ÏßÄ Ï∂îÍ∞Ä
            if (!visibleNodeIds.has(fromId) || !visibleNodeIds.has(toId)) {
              return;
            }

            const edgeType = edge.type || "transaction";
            const hop = edge.hop || 1;

            // Ïó£ÏßÄ ÏÉâÏÉÅ (Pathfinder Ïä§ÌÉÄÏùº: Ï¥àÎ°ùÏÉâ)
            let edgeColor = "#4CAF50"; // Í∏∞Î≥∏ Ï¥àÎ°ùÏÉâ
            if (edgeType === "rule_connection") {
              edgeColor = "#667eea";
            } else if (edgeType === "tag_connection") {
              edgeColor = "#ff9800";
            } else if (hop === 1) {
              edgeColor = "#4CAF50"; // 1-hopÏùÄ Ï¥àÎ°ùÏÉâ
            } else {
              edgeColor = "#81C784"; // ÎÇòÎ®∏ÏßÄÎäî Ïó∞Ìïú Ï¥àÎ°ùÏÉâ
            }

            let edgeConfig = {
              id: edge.id,
              from: fromId,
              to: toId,
              label: edge.label || "", // ÎùºÎ≤®ÏùÄ Î∞±ÏóîÎìúÏóêÏÑú Ïù¥ÎØ∏ Í∞ÑÏÜåÌôîÎê®
              color: edgeColor,
              dashes: edge.dashes || false,
              width: edge.width || Math.max(1, 3 - hop * 0.5), // Î∞±ÏóîÎìúÏóêÏÑú Í≥ÑÏÇ∞Ìïú width ÏÇ¨Ïö©
              hop: hop,
              transactions: edge.transactions || [], // Í±∞Îûò Ï†ïÎ≥¥ Ï∂îÍ∞Ä
              arrows: {
                to: {
                  enabled: true,
                  scaleFactor: 0.8, // ÌôîÏÇ¥Ìëú ÌÅ¨Í∏∞ Ï§ÑÏûÑ
                },
              },
            };

            graphEdges.push(edgeConfig);
          });
        }

        // ÎîîÎ≤ÑÍπÖ: ÎÖ∏ÎìúÏôÄ Ïó£ÏßÄ Í∞úÏàò ÌôïÏù∏
        console.log("üìä Í∑∏ÎûòÌîÑ Îç∞Ïù¥ÌÑ∞:", {
          nodes: graphNodes.length,
          edges: graphEdges.length,
          mainAddress: mainAddress,
        });

        if (graphNodes.length === 0) {
          console.warn("‚ö†Ô∏è ÎÖ∏ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§!");
          return;
        }

        if (graphEdges.length === 0) {
          console.warn(
            "‚ö†Ô∏è Ïó£ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§! Í∑∏ÎûòÌîÑÍ∞Ä Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïòÏùÑ Ïàò ÏûàÏäµÎãàÎã§."
          );
        }

        // ÎÖ∏ÎìúÏôÄ Ïó£ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
        nodes.clear();
        edges.clear();
        nodes.add(graphNodes);
        edges.add(graphEdges);

        // Í∑∏ÎûòÌîÑ Î†àÏù¥ÏïÑÏõÉ Ï°∞Ï†ï
        setTimeout(() => {
          if (network) {
            network.fit({
              animation: {
                duration: 1000,
                easingFunction: "easeInOutQuad",
              },
            });
          }
        }, 100);
      }

      // ÎÖ∏Îìú Ï†ïÎ≥¥ ÌëúÏãú
      function showNodeInfo(nodeId) {
        if (!currentData) return;

        const infoPanel = document.getElementById("infoPanel");
        const infoContent = document.getElementById("infoContent");
        const infoTitle = document.getElementById("infoTitle");

        infoPanel.classList.remove("hidden");

        if (nodeId.startsWith("rule_")) {
          // Î£∞ ÎÖ∏Îìú Ï†ïÎ≥¥
          const ruleId = nodeId.replace("rule_", "");
          const rule = currentData.fired_rules.find(
            (r) => `rule_${r.rule_id}` === nodeId
          );
          if (rule) {
            infoTitle.textContent = "Rule Ï†ïÎ≥¥";
            infoContent.innerHTML = `
                        <div class="info-section">
                            <h3>Rule ID</h3>
                            <div class="address-display">${rule.rule_id}</div>
                        </div>
                        <div class="info-section">
                            <h3>Score</h3>
                            <div class="info-value">${rule.score}Ï†ê</div>
                        </div>
                    `;
          }
        } else if (nodeId.startsWith("tag_")) {
          // ÌÉúÍ∑∏ ÎÖ∏Îìú Ï†ïÎ≥¥
          const tag = nodeId.replace("tag_", "");
          infoTitle.textContent = "Risk Tag";
          infoContent.innerHTML = `
                    <div class="info-section">
                        <h3>Tag</h3>
                        <div class="info-value">${tag}</div>
                    </div>
                `;
        } else {
          // Î©îÏù∏ Ï£ºÏÜå Ï†ïÎ≥¥ (IKNA Ïä§ÌÉÄÏùº)
          const isMainAddress =
            nodeId.toLowerCase() === currentData.target_address.toLowerCase();
          const riskLevel = currentData.risk_level || "low";
          const stats = currentData.address_stats || {};

          // Ï£ºÏÜå ÌÉÄÏûÖ Í≤∞Ï†ï
          const addressType =
            stats.entity_type === "DEX"
              ? "ETH Smart Contract"
              : stats.entity_type === "Exchange"
              ? "ETH Address"
              : "ETH Address";

          // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ
          const formatDate = (timestamp) => {
            if (!timestamp) return "N/A";
            const date = new Date(timestamp * 1000);
            return date.toLocaleString("ko-KR", {
              year: "numeric",
              month: "short",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
          };

          // Í∏àÏï° Ìè¨Îß∑ÌåÖ (Îçî Ï†ïÌôïÌïòÍ≤å)
          const formatAmount = (amount) => {
            if (!amount || amount === 0) return "0.00";
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount)) return "0.00";

            if (numAmount >= 1e12) return `${(numAmount / 1e12).toFixed(2)}T`;
            if (numAmount >= 1e9) return `${(numAmount / 1e9).toFixed(2)}B`;
            if (numAmount >= 1e6) return `${(numAmount / 1e6).toFixed(2)}M`;
            if (numAmount >= 1e3) return `${(numAmount / 1e3).toFixed(2)}K`;
            return numAmount.toFixed(2);
          };

          infoTitle.textContent = addressType;
          infoContent.innerHTML = `
                     <div class="info-section" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                         <div class="address-display" style="font-size: 14px; font-weight: 500; margin-bottom: 8px;">${nodeId}</div>
                         ${
                           isMainAddress && stats.entity_name
                             ? `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                 <span style="font-size: 16px; font-weight: 600;">${
                                   stats.entity_name
                                 }</span>
                                 <span class="risk-badge ${riskLevel}" style="font-size: 11px; padding: 2px 8px;">${riskLevel.toUpperCase()}</span>
                               </div>`
                             : isMainAddress
                             ? `<span class="risk-badge ${riskLevel}">${riskLevel.toUpperCase()}</span>`
                             : `<span style="color: #666;">Hop ${nodeHop}</span>`
                         }
                     </div>
                     
                     ${
                       isMainAddress && stats.tags && stats.tags.length > 0
                         ? `<div class="info-section" style="margin-bottom: 15px;">
                             <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                               ${stats.tags
                                 .map(
                                   (tag) =>
                                     `<span class="tag" style="background: #f0f0f0; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${tag}</span>`
                                 )
                                 .join("")}
                             </div>
                           </div>`
                         : ""
                     }
                     
                     ${
                       isMainAddress && stats.total_received !== undefined
                         ? `<div class="info-section" style="margin-bottom: 15px;">
                             <h3 style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">Financial Summary</h3>
                             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                               <div>
                                 <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Total received</div>
                                 <div style="font-size: 16px; font-weight: 600;">${formatAmount(
                                   stats.total_received
                                 )} USD</div>
                               </div>
                               <div>
                                 <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Total sent</div>
                                 <div style="font-size: 16px; font-weight: 600;">${formatAmount(
                                   stats.total_sent
                                 )} USD</div>
                               </div>
                               <div style="grid-column: 1 / -1;">
                                 <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Balance</div>
                                 <div style="font-size: 16px; font-weight: 600;">${formatAmount(
                                   stats.balance
                                 )} USD</div>
                               </div>
                             </div>
                           </div>`
                         : ""
                     }
                     
                     ${
                       isMainAddress && (stats.first_usage || stats.last_usage)
                         ? `<div class="info-section" style="margin-bottom: 15px;">
                             <h3 style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">Usage Dates</h3>
                             <div style="display: grid; gap: 8px;">
                               <div>
                                 <div style="font-size: 11px; color: #999; margin-bottom: 2px;">Last usage</div>
                                 <div style="font-size: 12px;">${formatDate(
                                   stats.last_usage
                                 )}</div>
                               </div>
                               <div>
                                 <div style="font-size: 11px; color: #999; margin-bottom: 2px;">First usage</div>
                                 <div style="font-size: 12px;">${formatDate(
                                   stats.first_usage
                                 )}</div>
                               </div>
                             </div>
                           </div>`
                         : ""
                     }
                     
                     ${
                       isMainAddress && stats.graph_stats
                         ? `<div class="info-section" style="margin-bottom: 15px;">
                             <h3 style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">Relationship Metrics</h3>
                             <div style="display: grid; gap: 8px;">
                               <div style="display: flex; justify-content: space-between;">
                                 <span style="font-size: 11px; color: #999;">Outgoing Relationships</span>
                                 <span style="font-size: 12px; font-weight: 500;">${
                                   stats.graph_stats.outgoing_relationships ||
                                   stats.outgoing_count ||
                                   0
                                 }</span>
                               </div>
                               <div style="display: flex; justify-content: space-between;">
                                 <span style="font-size: 11px; color: #999;">Incoming Relationships</span>
                                 <span style="font-size: 12px; font-weight: 500;">${
                                   stats.graph_stats.incoming_relationships ||
                                   stats.incoming_count ||
                                   0
                                 }</span>
                               </div>
                               <div style="display: flex; justify-content: space-between;">
                                 <span style="font-size: 11px; color: #999;">Cluster Addresses</span>
                                 <span style="font-size: 12px; font-weight: 500;">${
                                   stats.graph_stats.cluster_addresses || 0
                                 }</span>
                               </div>
                             </div>
                           </div>`
                         : ""
                     }
                     
                     <div class="info-grid" style="margin-top: 15px;">
                        <div class="info-item">
                            <label>Risk Score</label>
                            <div class="value">${currentData.risk_score.toFixed(
                              1
                            )}</div>
                        </div>
                        <div class="info-item">
                            <label>Rule Score</label>
                            <div class="value">${currentData.rule_score.toFixed(
                              1
                            )}</div>
                        </div>
                        <div class="info-item">
                            <label>Graph Score</label>
                            <div class="value">${currentData.graph_score.toFixed(
                              1
                            )}</div>
                        </div>
                        <div class="info-item">
                            <label>Stage 1 Score</label>
                            <div class="value">${currentData.stage1_score.toFixed(
                              1
                            )}</div>
                        </div>
                        ${
                          currentData.stage2_score !== null
                            ? `<div class="info-item">
                                <label>Stage 2 Score</label>
                                <div class="value">${currentData.stage2_score.toFixed(
                                  1
                                )}</div>
                              </div>`
                            : ""
                        }
                    </div>
                    <div class="info-section">
                        <h3>Fired Rules</h3>
                        <div class="rules-list">
                            ${
                              currentData.fired_rules &&
                              currentData.fired_rules.length > 0
                                ? currentData.fired_rules
                                    .map(
                                      (rule) => `
                                    <div class="rule-item">
                                        <span class="rule-id">${rule.rule_id}</span> - ${rule.score}Ï†ê
                                    </div>
                                `
                                    )
                                    .join("")
                                : '<p style="color: #999;">Î∞úÎèôÎêú Î£∞Ïù¥ ÏóÜÏäµÎãàÎã§.</p>'
                            }
                        </div>
                    </div>
                    <div class="info-section">
                        <h3>Explanation</h3>
                        <p style="color: #666; line-height: 1.6;">${
                          currentData.explanation || "ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§."
                        }</p>
                    </div>
                `;
        }
      }

      // ÎÖ∏Îìú ÌôïÏû•/Ï∂ïÏÜå ÌÜ†Í∏Ä
      function toggleNodeExpansion(nodeId) {
        if (!currentData || !currentData.graph) {
          return;
        }

        const nodeIdLower = nodeId.toLowerCase();

        if (expandedNodes.has(nodeIdLower)) {
          // Ï∂ïÏÜå: Ìï¥Îãπ ÎÖ∏ÎìúÏùò ÌïòÏúÑ ÎÖ∏Îìú Ï†úÍ±∞
          expandedNodes.delete(nodeIdLower);
        } else {
          // ÌôïÏû•: Ìï¥Îãπ ÎÖ∏ÎìúÏùò ÌïòÏúÑ ÎÖ∏Îìú Ï∂îÍ∞Ä
          expandedNodes.add(nodeIdLower);
        }

        // Í∑∏ÎûòÌîÑ Ïû¨Íµ¨ÏÑ±
        buildGraphFromData(currentData.target_address, currentData);
      }

      // ÌäπÏ†ï hopÍπåÏßÄ ÌôïÏû•
      function expandToHop(hop) {
        if (!currentData || !currentData.graph) {
          return;
        }

        // Hop Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        document
          .querySelectorAll(".hop-btn")
          .forEach((btn) => btn.classList.remove("active"));

        // Hop 0 Î≤ÑÌäº Ï∂îÍ∞Ä (Î©îÏù∏ ÎÖ∏ÎìúÎßå)
        if (hop === 0) {
          const hop0Btn = document.getElementById("hop0Btn");
          if (hop0Btn) hop0Btn.classList.add("active");
        } else {
          const btn = document.getElementById(`hop${hop}Btn`);
          if (btn) btn.classList.add("active");
        }

        // ÌòÑÏû¨ ÏµúÎåÄ hop ÏóÖÎç∞Ïù¥Ìä∏
        currentMaxHop = hop;

        // Ìï¥Îãπ hopÍπåÏßÄÏùò Î™®Îì† ÎÖ∏Îìú ÌôïÏû•
        expandedNodes.clear();
        if (currentData.graph && currentData.graph.nodes) {
          currentData.graph.nodes.forEach((node) => {
            const nodeHop = node.hop || 0;
            if (nodeHop <= hop) {
              expandedNodes.add(node.id.toLowerCase());
            }
          });
        }

        // Í∑∏ÎûòÌîÑ Ïû¨Íµ¨ÏÑ±
        buildGraphFromData(currentData.target_address, currentData);

        // Î†àÏù¥ÏïÑÏõÉ Ïû¨Ï°∞Ï†ï
        if (network) {
          network.fit({
            animation: {
              duration: 500,
              easingFunction: "easeInOutQuad",
            },
          });
        }
      }

      // Ïó£ÏßÄ Ï†ïÎ≥¥ ÌëúÏãú (IKNA Ïä§ÌÉÄÏùº Í±∞Îûò ÏÉÅÏÑ∏ Ï†ïÎ≥¥)
      function showEdgeInfo(edgeId) {
        if (!currentData || !currentData.graph) return;

        const infoPanel = document.getElementById("infoPanel");
        const infoContent = document.getElementById("infoContent");
        const infoTitle = document.getElementById("infoTitle");

        infoPanel.classList.remove("hidden");

        // Ïó£ÏßÄ Ï†ïÎ≥¥ Ï∞æÍ∏∞
        const graphData = currentData.graph || { edges: [] };
        const edge = graphData.edges.find((e) => e.id === edgeId);

        if (!edge) {
          infoTitle.textContent = "Transaction";
          infoContent.innerHTML = `<p style="color: #999;">Í±∞Îûò Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>`;
          return;
        }

        const transactions = edge.transactions || [];
        const mainTx = transactions[0]; // Ï≤´ Î≤àÏß∏ Í±∞ÎûòÎ•º Î©îÏù∏ÏúºÎ°ú ÌëúÏãú

        if (!mainTx) {
          infoTitle.textContent = "Transaction";
          infoContent.innerHTML = `<p style="color: #999;">Í±∞Îûò Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
          return;
        }

        // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ
        const formatDate = (timestamp) => {
          if (!timestamp) return "N/A";
          const date = new Date(timestamp * 1000);
          return date.toLocaleString("ko-KR", {
            year: "numeric",
            month: "short",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        };

        // Í∏àÏï° Ìè¨Îß∑ÌåÖ
        const formatValue = (value) => {
          if (!value || value === 0) return "0 ETH";
          if (value >= 1) return `${value.toFixed(4)} ETH`;
          return `${(value * 1e18).toFixed(0)} Wei`;
        };

        const txHash = mainTx.tx_hash || edgeId;
        const fromAddr = mainTx.from || edge.from;
        const toAddr = mainTx.to || edge.to;
        const value = mainTx.usd_value || mainTx.value / 1e18 || 0;
        const timestamp = mainTx.timestamp || 0;

        infoTitle.textContent = "ETH Transaction";
        infoContent.innerHTML = `
          <div class="info-section" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
            <div style="font-size: 13px; font-weight: 500; margin-bottom: 8px; font-family: monospace;">${txHash.substring(
              0,
              10
            )}...${txHash.substring(txHash.length - 6)}</div>
          </div>
          
          <div class="info-section" style="margin-bottom: 15px;">
            <h3 style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">Transaction Summary</h3>
            <div style="display: grid; gap: 10px;">
              <div>
                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Value</div>
                <div style="font-size: 14px; font-weight: 500;">${formatValue(
                  value
                )}</div>
              </div>
              <div>
                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Sender</div>
                <div style="font-size: 12px; font-family: monospace;">${fromAddr.substring(
                  0,
                  10
                )}...${fromAddr.substring(fromAddr.length - 6)}</div>
              </div>
              <div>
                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Receiver</div>
                <div style="font-size: 12px; font-family: monospace;">${toAddr.substring(
                  0,
                  10
                )}...${toAddr.substring(toAddr.length - 6)}</div>
              </div>
              <div>
                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">Timestamp</div>
                <div style="font-size: 12px;">${formatDate(timestamp)}</div>
              </div>
            </div>
          </div>
          
          ${
            transactions.length > 1
              ? `<div class="info-section" style="margin-bottom: 15px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="font-size: 13px; color: #666; font-weight: 600;">Sub Transfers</h3>
                    <span style="font-size: 11px; color: #999;">${
                      transactions.length
                    } transfers</span>
                  </div>
                  <div style="max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                      <thead>
                        <tr style="background: #f5f5f5; border-bottom: 1px solid #ddd;">
                          <th style="padding: 6px; text-align: left; font-weight: 600;">From</th>
                          <th style="padding: 6px; text-align: left; font-weight: 600;">To</th>
                          <th style="padding: 6px; text-align: right; font-weight: 600;">Value</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${transactions
                          .map((tx) => {
                            const txFrom = tx.from || "";
                            const txTo = tx.to || "";
                            const txValue =
                              tx.usd_value || tx.value / 1e18 || 0;
                            return `
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                              <td style="padding: 6px; font-family: monospace; font-size: 10px;">${txFrom.substring(
                                0,
                                8
                              )}...${txFrom.substring(txFrom.length - 4)}</td>
                              <td style="padding: 6px; font-family: monospace; font-size: 10px;">${txTo.substring(
                                0,
                                8
                              )}...${txTo.substring(txTo.length - 4)}</td>
                              <td style="padding: 6px; text-align: right; font-weight: 500;">${formatValue(
                                txValue
                              )}</td>
                            </tr>
                          `;
                          })
                          .join("")}
                      </tbody>
                    </table>
                  </div>
                </div>`
              : ""
          }
        `;
      }

      // Ï†ïÎ≥¥ Ìå®ÎÑê Îã´Í∏∞
      function closeInfoPanel() {
        document.getElementById("infoPanel").classList.add("hidden");
      }

      // Í±∞Îûò Î™©Î°ù ÌëúÏãú
      function showTransactionsList(transactions) {
        const transactionsList = document.getElementById("transactionsList");
        const transactionsTable = document.getElementById("transactionsTable");

        if (!transactions || transactions.length === 0) {
          transactionsList.style.display = "none";
          return;
        }

        // Í±∞ÎûòÎ•º ÏãúÍ∞Ñ ÏàúÏÑúÎ°ú Ï†ïÎ†¨
        const sortedTxs = transactions
          .filter((tx) => tx.timestamp)
          .sort((a, b) => b.timestamp - a.timestamp)
          .slice(0, 50); // ÏµúÎåÄ 50Í∞úÎßå ÌëúÏãú

        if (sortedTxs.length === 0) {
          transactionsList.style.display = "none";
          return;
        }

        // ÌÖåÏù¥Î∏î ÏÉùÏÑ±
        let tableHTML = `
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr style="background: #f5f5f5; border-bottom: 1px solid #ddd;">
                <th style="padding: 8px; text-align: left;">ÏãúÍ∞Ñ</th>
                <th style="padding: 8px; text-align: left;">From</th>
                <th style="padding: 8px; text-align: left;">To</th>
                <th style="padding: 8px; text-align: right;">Í∏àÏï°</th>
              </tr>
            </thead>
            <tbody>
        `;

        sortedTxs.forEach((tx) => {
          const date = new Date(tx.timestamp * 1000);
          const dateStr = date.toLocaleString("ko-KR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          const fromAddr = tx.from || "";
          const toAddr = tx.to || "";

          // Í∞í Í≥ÑÏÇ∞: USD Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ WeiÎ•º ETHÎ°ú Î≥ÄÌôò
          let value = tx.usd_value || tx.amount_usd || 0;
          if (value === 0 || value === "0") {
            const valueWei = tx.value || tx.value_wei || 0;
            if (valueWei > 0) {
              const valueEth = valueWei / 1e18;
              // ETH Í∞ÄÍ≤©ÏùÑ ÎåÄÎûµÏ†ÅÏúºÎ°ú 2000 USDÎ°ú Ï∂îÏ†ï
              value = valueEth * 2000.0;
            }
          }

          // Í∏àÏï° Ìè¨Îß∑ÌåÖ Í∞úÏÑ†
          let valueStr = "0.00";
          if (value > 0) {
            if (value >= 1e12) {
              valueStr = `${(value / 1e12).toFixed(2)}T`;
            } else if (value >= 1e9) {
              valueStr = `${(value / 1e9).toFixed(2)}B`;
            } else if (value >= 1e6) {
              valueStr = `${(value / 1e6).toFixed(2)}M`;
            } else if (value >= 1e3) {
              valueStr = `${(value / 1e3).toFixed(2)}K`;
            } else {
              valueStr = value.toFixed(2);
            }
          }

          tableHTML += `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 6px; color: #666;">${dateStr}</td>
              <td style="padding: 6px; font-family: monospace; font-size: 11px;">${fromAddr.substring(
                0,
                10
              )}...</td>
              <td style="padding: 6px; font-family: monospace; font-size: 11px;">${toAddr.substring(
                0,
                10
              )}...</td>
              <td style="padding: 6px; text-align: right; font-weight: 500;">${valueStr}</td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        transactionsTable.innerHTML = tableHTML;
        transactionsList.style.display = "block";
      }

      // Í∑∏ÎûòÌîÑ Î¶¨ÏÖã
      function resetGraph() {
        nodes.clear();
        edges.clear();
        expandedNodes.clear();
        nodeHopMap.clear();
        currentMaxHop = 0;
        currentData = null;
        document.getElementById("emptyState").style.display = "flex";
        closeInfoPanel();

        // Hop Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
        document
          .querySelectorAll(".hop-btn")
          .forEach((btn) => btn.classList.remove("active"));
        const hop0Btn = document.getElementById("hop0Btn");
        if (hop0Btn) hop0Btn.classList.add("active");
      }

      // Ï§å Ïù∏
      function zoomIn() {
        if (network) {
          const scale = network.getScale();
          network.moveTo({ scale: scale * 1.2 });
        }
      }

      // Ï§å ÏïÑÏõÉ
      function zoomOut() {
        if (network) {
          const scale = network.getScale();
          network.moveTo({ scale: scale * 0.8 });
        }
      }

      // ÏÑ§Ï†ï
      function showSettings() {
        alert("ÏÑ§Ï†ï Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.");
      }

      // ÏòàÏãú Ï£ºÏÜå ÏûÖÎ†•
      function fillExample() {
        document.getElementById("addressInput").value =
          "0x3e66b66fd1d0b02fda6c811da9e0547970db2f21";
      }

      // Enter ÌÇ§Î°ú Í≤ÄÏÉâ
      document
        .getElementById("addressInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            analyzeAddress();
          }
        });

      // Ï¥àÍ∏∞Ìôî
      initGraph();
    </script>
  </body>
</html>
