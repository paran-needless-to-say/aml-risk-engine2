# TRACE-X 룰북 설명서

AML (Anti-Money Laundering) 리스크 스코어링을 위한 TRACE-X 룰북의 상세 설명입니다.

## 📋 목차

1. [루북 구조](#루북-구조)
2. [Compliance (C) 룰](#compliance-c-룰)
3. [Exposure (E) 룰](#exposure-e-룰)
4. [Behavior (B) 룰](#behavior-b-룰)
5. [룰 평가 방식](#룰-평가-방식)

---

## 룰북 구조

### Meta 정보
```yaml
meta:
  version: "1.0"
  namespace: "TRACE-X"
  description: "Compliance/Exposure/Behavior rulebook v1"
```

### 기본 설정
```yaml
defaults:
  currency: "USD"
  fields:
    timestamp: "timestamp"
    from: "from"
    to: "to"
    usd_value: "usd_value"
```

### 룰 구조
각 룰은 다음 요소로 구성됩니다:
- **id**: 룰 고유 식별자 (예: C-001)
- **name**: 룰 이름
- **axis**: 룰 축 (C: Compliance, E: Exposure, B: Behavior)
- **severity**: 심각도 (HIGH, MEDIUM, LOW)
- **match**: 매칭 조건 (어떤 트랜잭션에 적용할지)
- **conditions**: 추가 조건 (금액, 횟수 등)
- **exceptions**: 예외 조건 (CEX 내부 거래 등)
- **score**: 리스크 점수 (0~100)
- **window**: 시간 윈도우 (선택)
- **aggregations**: 집계 조건 (선택)

---

## Compliance (C) 룰

**목적**: 규제 준수 관련 리스크 감지

### C-001: Sanction Direct Touch (제재 대상 직접 접촉)

**의미**: OFAC 제재 리스트에 등록된 주소와 직접 거래

**조건**:
- `from` 또는 `to`가 SDN 리스트에 포함
- 금액 >= 1 USD

**예외**: CEX 내부 거래

**점수**: 30점 (HIGH)

**예시**:
```
거래: 0xnormal → 0xsanctioned (100 USD)
→ C-001 룰 발동 (30점)
```

### C-002: High-Risk Jurisdiction VASP (고위험 국가 VASP)

**의미**: 고위험 국가(IR, RU, KP)의 VASP와 거래

**조건**:
- 상대방이 고위험 국가 VASP
- 안전한 VASP가 아님

**점수**: 20점 (MEDIUM)

**현재 상태**: 미구현 (tag 기반, 백엔드에서 제공 필요)

### C-003: High-Value Single Transfer (고액 단일 거래)

**의미**: 단일 거래에서 7,000 USD 이상 전송

**조건**:
- `usd_value >= 7000`

**예외**: CEX 내부 거래

**점수**: 20점 (MEDIUM)

**예시**:
```
거래: 0xuser → 0xrecipient (10,000 USD)
→ C-003 룰 발동 (20점)
```

### C-004: High-Value Repeated Transfer (24h) (24시간 내 반복 고액 거래)

**의미**: 24시간 내 반복적으로 고액 거래

**조건** (윈도우 기반):
- 24시간 내 (`duration_sec: 86400`)
- 합계 >= 10,000 USD
- 개수 >= 3회
- 각 거래 >= 3,000 USD

**예외**: 마켓 메이커 봇, CEX 내부 거래

**점수**: 20점 (MEDIUM)

**예시**:
```
10:00 - 3,500 USD
15:00 - 4,000 USD
20:00 - 3,500 USD
22:00 - 3,000 USD
→ 합계: 14,000 USD, 4회 거래
→ C-004 룰 발동 (20점)
```

---

## Exposure (E) 룰

**목적**: 위험한 주소/서비스와의 노출 감지

### E-101: Mixer Direct Exposure (믹서 직접 노출)

**의미**: 믹서(토네이도 캐시 등)에서 직접 자금 유입

**조건**:
- `from`이 MIXER 리스트에 포함
- 금액 >= 20 USD

**예외**: 리워드 지급

**점수**: 25점 (HIGH)

**예시**:
```
거래: 0xmixer → 0xuser (500 USD)
→ E-101 룰 발동 (25점)
```

### E-102: Indirect Sanctions Exposure (≤2 hops) (간접 제재 노출)

**의미**: 제재 대상과 1~2홉 이내 거래

**조건**:
- 주소가 SDN_HOP1 또는 SDN_HOP2 리스트에 포함
- 금액 >= 20 USD

**예외**: CEX 내부 거래

**점수**: 30점 (HIGH)

**현재 상태**: 미구현 (hop 리스트 필요, 백엔드에서 제공 필요)

### E-103: Counterparty Quality Risk (상대방 품질 리스크)

**의미**: 상대방의 리스크 스코어가 높음

**조건**:
- `counterparty.risk_score >= 0.7`

**점수**: 10~20점 (동적, 기본 15점)

**현재 상태**: 미구현 (상대방 리스크 스코어 필요)

---

## Behavior (B) 룰

**목적**: 의심스러운 거래 패턴 감지

### B-101: Burst (10m) (10분 내 급증)

**의미**: 10분 내 3회 이상 거래

**조건** (윈도우 기반):
- 10분 내 (`duration_sec: 600`)
- 거래 개수 >= 3회
- 쿨다운: 30분 (`cooldown_sec: 1800`)

**예외**: CEX 내부 거래, 마켓 메이커 봇

**점수**: 15점 (MEDIUM)

**예시**:
```
10:00 - 거래 1
10:05 - 거래 2
10:08 - 거래 3
→ B-101 룰 발동 (15점)
```

### B-102: Rapid Sequence (1m) (1분 내 급속 연속)

**의미**: 1분 내 5회 이상 거래

**조건** (윈도우 기반):
- 1분 내 (`duration_sec: 60`)
- 거래 개수 >= 5회
- 쿨다운: 15분 (`cooldown_sec: 900`)

**예외**: CEX 내부 거래, 마켓 메이커 봇

**점수**: 20점 (HIGH)

### B-103: Inter-arrival Std High (도착 간격 표준편차 높음)

**의미**: 거래 간격의 표준편차가 높음 (불규칙한 패턴)

**조건**:
- 최소 10개 거래 필요
- `interarrival_std >= 2.0`
- 금액 >= 50 USD

**점수**: 10점 (LOW)

**현재 상태**: 미구현 (prerequisites, 통계 계산 필요)

### B-201: Layering Chain (same token) (레이어링 체인)

**의미**: 같은 토큰으로 3홉 이상 체인 거래 (자금 세탁 레이어링)

**조건** (토폴로지 기반):
- 같은 토큰
- 홉 길이 >= 3
- 각 홉 금액 차이 <= 5%
- 최소 금액 >= 100 USD

**점수**: 25점 (HIGH)

**현재 상태**: 미구현 (topology 분석 필요)

### B-202: Cycle (length 2-3, same token) (순환 거래)

**의미**: 같은 토큰으로 2~3홉 순환 거래

**조건** (토폴로지 기반):
- 같은 토큰
- 순환 길이: 2~3
- 순환 총액 >= 100 USD

**점수**: 30점 (HIGH)

**현재 상태**: 미구현 (topology 분석 필요)

### B-203: Fan-out (10m bucket) (10분 버킷 팬아웃)

**의미**: 10분 내 같은 주소에서 여러 주소로 대량 송금

**조건** (버킷 기반):
- 10분 버킷
- 고유 수신 주소 >= 5개
- 합계 >= 1,000 USD
- 각 거래 >= 100 USD

**점수**: 20점 (MEDIUM)

**현재 상태**: 미구현 (bucket 분석 필요)

### B-204: Fan-in (10m bucket) (10분 버킷 팬인)

**의미**: 10분 내 여러 주소에서 같은 주소로 대량 입금

**조건** (버킷 기반):
- 10분 버킷
- 고유 송신 주소 >= 5개
- 합계 >= 1,000 USD
- 각 거래 >= 100 USD

**점수**: 20점 (MEDIUM)

**현재 상태**: 미구현 (bucket 분석 필요)

### B-401: First 7 Days Burst (첫 7일 급증)

**의미**: 주소 생성 후 7일 내 대량 거래

**조건** (상태 기반):
- 주소 나이 <= 7일
- 첫 7일 총액 >= 10,000 USD
- 첫 7일 거래 수 >= 3회

**점수**: 20점 (MEDIUM)

**현재 상태**: 미구현 (state 관리 필요)

### B-402: Reactivation (재활성화)

**의미**: 오래된 주소가 장기간 비활성 후 재활성화

**조건** (상태 기반):
- 주소 나이 >= 365일
- 비활성 기간 >= 180일
- 재활성 거래 금액 >= 1,000 USD

**점수**: 15점 (LOW)

**현재 상태**: 미구현 (state 관리 필요)

### B-403A: Lifecycle A — Young but Busy (젊지만 바쁨)

**의미**: 30일 이내 주소가 매우 활발한 거래

**조건**:
- 주소 나이 <= 30일
- 30일 내 거래 수 >= 100회
- 30일 내 중간 금액 >= 100 USD

**점수**: 10점 (LOW)

**현재 상태**: 미구현 (상태 필드 필요)

### B-403B: Lifecycle B — Old and Rare High Value (오래되었지만 드물게 고액)

**의미**: 오래된 주소가 드물게 고액 거래

**조건**:
- 주소 나이 >= 365일
- 총 거래 수 <= 10회
- 총액 >= 50,000 USD
- 중간 금액 >= 5,000 USD

**점수**: 10점 (LOW)

**현재 상태**: 미구현 (상태 필드 필요)

### B-501: High-Value Buckets (고액 버킷)

**의미**: 거래 금액에 따른 동적 점수

**조건** (버킷 기반):
- 10,000 ~ 50,000 USD: 5점
- 50,000 ~ 250,000 USD: 10점
- 250,000 ~ 1,000,000 USD: 15점
- >= 1,000,000 USD: 20점

**점수**: 동적 (5~20점)

**현재 상태**: 미구현 (buckets 분석 필요)

### B-502: Structuring — Rounded Value Repetition (24h outgoing) (구조화 - 반올림 값 반복)

**의미**: 24시간 내 반올림된 금액으로 반복 송금 (구조화 의심)

**조건** (윈도우 기반):
- 24시간 내
- 송금 방향 (`direction:outgoing`)
- 하나라도 >= 10,000,000 USD (KRW 스케일 허용)
- 같은 반올림 값으로 그룹화
- 각 그룹: 개수 >= 5회, 합계 >= 10,000 USD

**점수**: 10점 (LOW)

**현재 상태**: 미구현 (group_by_value, per_group 필요)

---

## 룰 평가 방식

### 1. 단일 트랜잭션 룰

**예시**: C-001, C-003, E-101

```
1. match 조건 확인 (어떤 트랜잭션에 적용?)
2. conditions 확인 (추가 조건 만족?)
3. exceptions 확인 (예외에 해당?)
4. 룰 발동 → score 추가
```

### 2. 윈도우 기반 룰

**예시**: C-004, B-101, B-102

```
1. 시간 윈도우 내 트랜잭션 수집
2. aggregations 조건 확인 (합계, 개수 등)
3. exceptions 확인
4. 룰 발동 → score 추가
```

### 3. 토폴로지 기반 룰

**예시**: B-201, B-202

```
1. 그래프 구조 분석 (홉, 순환 등)
2. 토폴로지 조건 확인
3. 룰 발동 → score 추가
```

**현재 상태**: 미구현

### 4. 버킷 기반 룰

**예시**: B-203, B-204, B-501

```
1. 시간 버킷으로 그룹화
2. 버킷별 집계 조건 확인
3. 룰 발동 → score 추가
```

**현재 상태**: 미구현

### 5. 상태 기반 룰

**예시**: B-401, B-402, B-403A, B-403B

```
1. 주소 상태 정보 확인 (나이, 거래 수 등)
2. 상태 조건 확인
3. 룰 발동 → score 추가
```

**현재 상태**: 미구현

---

## 현재 구현 상태

### ✅ 구현 완료

- **C-001**: Sanction Direct Touch
- **C-003**: High-Value Single Transfer
- **C-004**: High-Value Repeated Transfer (24h) - 윈도우 기반
- **E-101**: Mixer Direct Exposure
- **B-101**: Burst (10m) - 윈도우 기반
- **B-102**: Rapid Sequence (1m) - 윈도우 기반

### 🚧 부분 구현

- **C-002**: High-Risk Jurisdiction VASP (tag 기반, 백엔드 데이터 필요)
- **E-102**: Indirect Sanctions Exposure (hop 리스트 필요)
- **E-103**: Counterparty Quality Risk (상대방 스코어 필요)

### ❌ 미구현

- **B-103**: Inter-arrival Std High (prerequisites, 통계 계산)
- **B-201, B-202**: 토폴로지 분석 (그래프 구조)
- **B-203, B-204**: 버킷 분석
- **B-401, B-402, B-403A, B-403B**: 상태 관리
- **B-501**: 버킷 기반 동적 점수
- **B-502**: 구조화 패턴 (group_by_value, per_group)

---

## 점수 체계

### 점수 범위
- **0~100점**: 최종 리스크 스코어
- 각 룰은 0~30점 범위에서 기여

### 리스크 레벨
- **low**: 0~30점
- **medium**: 31~60점
- **high**: 61~80점
- **critical**: 81~100점

### 예시
```
C-001 (30점) + E-101 (25점) + C-003 (20점) = 75점
→ risk_level: "high"
```

---

## 예외 처리

대부분의 룰은 다음 예외를 포함합니다:

1. **CEX_INTERNAL**: 거래소 내부 거래
2. **MM_BOT**: 마켓 메이커 봇
3. **REWARD_PAYOUT**: 리워드 지급

이러한 예외는 정상적인 거래 패턴이므로 리스크 점수에서 제외됩니다.

