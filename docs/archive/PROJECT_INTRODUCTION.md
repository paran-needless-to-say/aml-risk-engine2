# 프로젝트 소개: CEX용 하이브리드 AML 리스크 스코어링 시스템

## 📋 프로젝트 개요

본 프로젝트는 **중앙화 거래소(CEX)를 위한 고도화된 AML(Anti-Money Laundering) 리스크 스코어링 시스템**입니다. 블록체인 주소의 거래 히스토리를 다각도로 분석하여 의심스러운 거래와 세탁 자금 유입 패턴을 실시간으로 탐지하고, 0부터 100까지의 정량적 리스크 점수를 제공합니다.

### 배경 및 필요성

암호화폐 시장의 급속한 성장과 함께 피싱, 해킹, 자금 세탁 등 불법 거래가 지속적으로 증가하고 있습니다. 특히 블록체인의 익명성 특성으로 인해 전통적인 금융 기관의 규제 시스템으로는 효과적인 탐지가 어렵습니다. CEX는 사용자 자금의 안전을 보장하고 규제 기관의 요구사항을 충족하기 위해, 실시간으로 주소와 거래를 분석하여 리스크를 평가할 수 있는 시스템이 필수적입니다.

기존의 단일 접근 방식(룰 기반, 그래프 분석, 머신러닝)은 각각 한계가 있습니다:

- **룰 기반 시스템**: 해석 가능하지만 복잡한 패턴을 놓칠 수 있음
- **순수 머신러닝**: 높은 성능이지만 설명 가능성이 부족하고 도메인 지식 반영이 어려움
- **그래프 기반 방법**: 강력하지만 계산 비용이 높고 확장성이 제한적
- **하이브리드 접근**: 룰과 ML의 경계가 모호하고 최적화가 어려움

본 시스템은 이러한 한계를 극복하기 위해 **2단계 하이브리드 아키텍처**를 제안하고 구현했습니다.

---

## 🎯 핵심 차별성

### 1. 2단계 하이브리드 아키텍처

본 시스템의 가장 큰 차별점은 **명확하게 분리된 2단계 구조**입니다:

#### 1단계: Rule-Based + 그래프 통계 기반 스코어링

- **Rule-based 점수 (90%)**: TRACE-X 룰북 기반 규칙 평가
- **그래프 통계 점수 (10%)**: 거래 네트워크의 구조적 특성 분석
- **특징**: 빠른 응답 시간(1-2초), 해석 가능한 결과, 도메인 지식 반영

#### 2단계: AI 기반 가중치 조정 및 랭킹

- **30차원 Feature 추출**: 1단계 결과 + 그래프 통계 + PPR 점수
- **머신러닝 모델**: Logistic Regression, Random Forest, Gradient Boosting
- **최종 점수**: 1단계 점수(60%) + ML 예측 점수(40%)의 가중 평균
- **특징**: 복잡한 패턴 학습, 높은 정확도, 자동 최적화

이러한 2단계 구조는 다음과 같은 장점을 제공합니다:

- **해석 가능성**: 1단계에서 명확한 룰 기반 점수 제공
- **성능**: 2단계에서 ML이 복잡한 패턴 보완
- **유연성**: 각 단계를 독립적으로 개선 및 최적화 가능
- **확장성**: 새로운 룰 추가나 ML 모델 교체가 용이

### 2. TRACE-X 룰북 기반 규칙 평가

본 시스템은 **TRACE-X 룰북**을 기반으로 19개의 세밀한 규칙을 구현했습니다. 룰은 3개의 축(Axis)으로 분류됩니다:

#### Compliance (C) 축: 규제 준수 관련

- **C-001**: 제재 대상 주소와의 직접 거래 탐지
- **C-003**: 고액 단일 거래 탐지 (7,000 USD 이상)
- **C-004**: 24시간 내 반복 고액 거래 탐지 (합계 10,000 USD 이상, 3회 이상)

#### Exposure (E) 축: 위험 노출 관련

- **E-101**: 믹서(토네이도 캐시 등)에서의 직접 자금 유입 탐지
- **E-102**: 간접 제재 노출 탐지 (PPR 기반, 2홉 이내)

#### Behavior (B) 축: 행동 패턴 관련

- **B-101**: 버스트 패턴 탐지 (10분 내 다수 거래)
- **B-102**: 급속 연속 거래 탐지 (1분 내 다수 거래)
- **B-201**: 레이어링 체인 탐지 (3홉 데이터 기반, 자금 세탁의 전형적 패턴)
- **B-202**: 순환 패턴 탐지 (3홉 데이터 기반, 자금 순환 구조)
- **B-203**: Fan-out 패턴 탐지 (10분 버킷, 자금 분산)
- **B-204**: Fan-in 패턴 탐지 (10분 버킷, 자금 집중)

각 룰은 심각도(CRITICAL, HIGH, MEDIUM, LOW)에 따라 기본 점수가 할당되며, 여러 룰이 동시에 발동될 경우 보너스 점수가 추가됩니다.

### 3. MPOCryptoML 방법론 통합

본 시스템은 **MPOCryptoML 논문의 방법론**을 통합하여 그래프 기반 패턴 분석을 수행합니다:

#### Multi-source Personalized PageRank (PPR)

- 제재 주소(SDN) 및 믹서 주소를 소스 노드로 설정
- 타겟 주소까지의 연결성을 PPR 점수로 정량화
- 간접적 위험 노출을 탐지 (E-102 룰)

#### 그래프 패턴 탐지 (MPOCryptoML 방식)

**룰 기반 패턴 탐지와의 차이점**:

본 시스템에는 두 가지 패턴 탐지 방식이 있습니다:

1. **룰 기반 패턴 탐지** (TRACE-X 룰북):

   - **B-203 (Fan-out)**: 10분 버킷 내에서 5개 이상의 서로 다른 주소로 분산 + 합계 1,000 USD 이상
   - **B-204 (Fan-in)**: 10분 버킷 내에서 5개 이상의 서로 다른 주소에서 집중 + 합계 1,000 USD 이상
   - **B-201 (Layering Chain)**: 3홉 이상의 체인 구조, 동일 토큰, 금액 차이 5% 이내
   - **B-202 (Cycle)**: 2-3 길이의 순환 구조, 동일 토큰, 총액 100 USD 이상
   - **특징**: 시간 기반 집계(버킷/윈도우) + 특정 임계값 조건으로 명확한 규칙 기반 탐지

2. **MPOCryptoML 패턴 탐지** (논문 방법론):
   - **Fan-in**: 수학적 정의 `d_i^-(S) = Σ_{v_k ∈ M_{l-1} ∧ (k,v) ∈ E} e_{kv}` 기반 탐지
   - **Fan-out**: 수학적 정의 `d_i^+(S) = Σ_{v_j ∈ M_{l+1} ∧ (v,j) ∈ E} e_{vj}` 기반 탐지
   - **Gather-scatter**: Fan-in + Fan-out 조합 (세탁의 전형적 패턴)
   - **Stack**: directed path P = (v1, v2, ..., vk) 패턴
   - **Bipartite**: 이분 그래프 구조 `∀(u, v) ∈ E, u ∈ M_l ⇒ v ∈ M_{l+1}`
   - **특징**: 시간 제약 없이 그래프 구조 자체를 수학적으로 분석, 더 유연한 패턴 탐지

**왜 두 가지가 필요한가?**

- **룰 기반**: 규제 요구사항에 맞춘 명확한 기준, 해석 가능성, 실시간 탐지에 적합
- **MPOCryptoML**: 복잡한 그래프 구조에서 숨겨진 패턴 발견, 연구 기반 방법론, ML feature로 활용

#### 정규화 점수

- **Nθ (Normalized Timestamp Score)**: 시간적 비대칭성 측정
  - 세탁 계정은 유입 후 빠른 유출 패턴을 보임
- **Nω (Normalized Weight Score)**: 거래 금액 불균형 측정
  - 유입/유출 금액 분포의 차이 분석

### 4. OFAC SDN 리스트 자동 통합

미국 재무부 OFAC(Office of Foreign Assets Control)의 SDN(Specially Designated Nationals) 리스트를 자동으로 파싱하고 통합합니다. XML 형식의 제재 리스트를 주기적으로 업데이트하여 최신 제재 대상 주소를 실시간으로 탐지할 수 있습니다.

### 5. 실시간 및 심층 분석 모드

사용자의 요구사항에 따라 두 가지 분석 모드를 제공합니다:

#### 기본 스코어링 (Basic)

- **응답 시간**: 1-2초
- **범위**: 기본 룰만 평가 (B-201, B-202 제외)
- **용도**: 실시간 대시보드, 빠른 의사결정

#### 심층 분석 (Advanced)

- **응답 시간**: 5-30초
- **범위**: 모든 룰 평가 (그래프 구조 분석 포함)
- **용도**: 수동 조사, 상세 분석, 리포트 생성

---

## 🔍 이상거래 탐지 방법론

본 시스템은 다음과 같은 다층적 접근 방식으로 이상거래를 탐지합니다:

### 1단계: 거래 데이터 수집 및 전처리

#### 데이터 수집

- **직접 거래**: 분석 대상 주소의 모든 입출금 거래
- **3홉 거래**: 그래프 구조 분석을 위한 확장 거래 데이터
  - 1홉: 직접 거래 상대방
  - 2홉: 상대방의 거래 상대방
  - 3홉: 2홉의 거래 상대방
- **메타데이터**: 거래 금액(USD), 타임스탬프, 블록 높이, 체인 정보

#### 전처리

- 블랙리스트/화이트리스트 매칭
  - SDN 리스트: 제재 대상 주소
  - 믹서 리스트: 토네이도 캐시 등
  - 브릿지 컨트랙트: 크로스체인 브릿지
  - CEX 주소: 중앙화 거래소 주소
- 거래 금액 USD 변환
- 타임스탬프 정규화

### 2단계: 룰 기반 평가

#### 단일 거래 평가

각 거래에 대해 TRACE-X 룰북의 규칙을 순차적으로 평가합니다:

1. **매칭 조건 확인**: 룰의 `match` 조건이 거래에 부합하는지 확인
   - 예: `from` 또는 `to`가 SDN 리스트에 포함되는가?
2. **추가 조건 확인**: `conditions`에서 금액, 횟수 등의 조건 확인
   - 예: 거래 금액이 7,000 USD 이상인가?
3. **예외 조건 확인**: `exceptions`에서 예외 상황 확인
   - 예: CEX 내부 거래인가?
4. **점수 할당**: 조건을 만족하면 룰의 점수를 할당

#### 집계 기반 평가

시간 윈도우나 버킷 내에서 여러 거래를 집계하여 평가합니다:

- **윈도우 기반 집계**: 특정 시간 범위 내 거래 집계
  - 예: 24시간 내 합계 금액이 10,000 USD 이상인가?
- **버킷 기반 집계**: 시간 버킷으로 그룹화하여 집계
  - 예: 10분 버킷 내 거래 개수와 금액 분석

#### 개선된 룰 스코어링

단순 합산이 아닌 지능적 점수 계산:

1. **가중 합산**: 발동된 룰들의 점수를 가중 합산
2. **중복 룰 페널티**: 동일한 룰이 여러 번 발동되면 페널티 적용
3. **보너스 점수**:
   - **룰 개수 보너스**: 발동된 고유 룰이 많을수록 보너스
   - **심각도 보너스**: CRITICAL/HIGH 룰이 많을수록 보너스
   - **축 다양성 보너스**: 여러 축(C, E, B)에서 룰이 발동되면 보너스

### 3단계: 그래프 구조 분석

#### 거래 그래프 구축

거래 데이터로부터 방향성 그래프 G = (V, E, W, T)를 구축합니다:

- **V (노드)**: 주소
- **E (엣지)**: 거래
- **W (가중치)**: 거래 금액
- **T (타임스탬프)**: 거래 시간

#### 그래프 통계 추출

다음과 같은 통계적 특성을 추출합니다:

- **Fan-in/Fan-out 통계**:
  - `fan_in_count`: 유입 거래 개수
  - `fan_out_count`: 유출 거래 개수
  - `fan_in_value`: 유입 거래 총액
  - `fan_out_value`: 유출 거래 총액
- **거래 금액 통계**:
  - `avg_transaction_value`: 평균 거래 금액
  - `max_transaction_value`: 최대 거래 금액
  - `total_transaction_value`: 총 거래 금액
- **그래프 크기**:
  - `graph_nodes`: 그래프 노드 수
  - `graph_edges`: 그래프 엣지 수
  - `num_transactions`: 총 거래 수

#### 그래프 점수 계산

통계적 특성을 기반으로 점수를 계산합니다:

- **Fan-in/out 기반 점수**:
  - Fraud는 fan_in_count가 낮고(평균 8.92), fan_out_count가 높음(평균 28.53)
  - Normal은 fan_in_count가 높고(평균 13.46), fan_out_count가 낮음(평균 19.91)
- **패턴 점수 기반**:
  - Fraud는 pattern_score가 낮음(평균 21.24)
  - Normal은 pattern_score가 높음(평균 38.40)
- **정규화 점수 기반**:
  - Fraud는 n_omega가 낮음(평균 0.44)
  - Normal은 n_omega가 높음(평균 0.57)

### 4단계: PPR 기반 연결성 분석

#### Multi-source PPR 계산

제재 주소와 믹서 주소를 소스 노드로 설정하여 Personalized PageRank를 계산합니다:

1. **소스 노드 식별**: out-degree가 0이 아닌 노드 중 SDN/믹서 주소
2. **PPR 계산**: 소스 노드에서 시작하는 랜덤 워크 점수 계산
3. **연결성 점수**: 타겟 주소의 PPR 점수가 높을수록 위험도 증가

이를 통해 **간접적 위험 노출**을 탐지할 수 있습니다. 예를 들어, 제재 주소와 직접 거래하지 않았더라도, 2홉 이내에 연결되어 있다면 위험도가 증가합니다.

### 5단계: 패턴 탐지

패턴 탐지는 두 가지 방식으로 수행됩니다:

#### 5-1. 룰 기반 패턴 탐지 (TRACE-X 룰북)

시간 기반 집계와 명확한 임계값을 사용하여 패턴을 탐지합니다:

- **B-203 (Fan-out)**: 10분 버킷 내에서 5개 이상의 서로 다른 주소로 분산
  - 세탁 과정의 "Layering" 단계를 시간 제약과 함께 탐지
- **B-204 (Fan-in)**: 10분 버킷 내에서 5개 이상의 서로 다른 주소에서 집중
  - 세탁 과정의 "Placement" 단계를 시간 제약과 함께 탐지
- **B-201 (Layering Chain)**: 3홉 이상의 체인 구조, 동일 토큰, 금액 차이 5% 이내
  - 자금이 여러 단계를 거쳐 이동하는 패턴
- **B-202 (Cycle)**: 2-3 길이의 순환 구조, 동일 토큰
  - 자금이 순환하는 의심스러운 패턴

이 패턴들은 룰 평가 단계에서 점수로 반영됩니다.

#### 5-2. MPOCryptoML 패턴 탐지 (논문 방법론)

그래프 구조 자체를 수학적으로 분석하여 패턴을 탐지합니다:

- **Fan-in 패턴**: 수학적 정의에 따른 유입 패턴 탐지
  - 시간 제약 없이 전체 그래프에서 분석
- **Fan-out 패턴**: 수학적 정의에 따른 유출 패턴 탐지
  - 시간 제약 없이 전체 그래프에서 분석
- **Gather-scatter 패턴**: Fan-in + Fan-out 조합
  - 전형적인 자금 세탁 구조를 그래프 구조로 탐지
- **Stack 패턴**: 선형 경로를 통한 자금 이동
  - directed path 구조 탐지
- **Bipartite 패턴**: 이분 그래프 구조
  - 특정 계층 구조를 가진 그래프 탐지

이 패턴들은 그래프 통계 점수와 ML feature로 활용됩니다.

**두 방식의 차이**:

- **룰 기반**: 시간 제약(10분 버킷) + 명확한 임계값(5개 주소, 1,000 USD) → 규제 요구사항에 맞춘 탐지
- **MPOCryptoML**: 시간 제약 없음 + 수학적 정의 기반 → 더 유연하고 복잡한 패턴 탐지

### 6단계: 1단계 점수 계산

Rule-based 점수와 그래프 통계 점수를 가중 평균하여 1단계 점수를 계산합니다:

```
1단계 점수 = 0.9 × Rule-based 점수 + 0.1 × 그래프 통계 점수
```

이 가중치는 실제 데이터 분석을 통해 최적화되었으며, Rule-based 점수가 더 높은 신뢰도를 가지도록 설정되었습니다.

### 7단계: 2단계 ML 기반 점수 조정

#### Feature 추출

1단계 결과와 그래프 통계로부터 30차원의 feature 벡터를 추출합니다:

1. **1단계 점수 features** (3차원):
   - rule_score, graph_score, risk_score
2. **Rule-based features** (10차원):
   - 발동된 룰 개수
   - 축별 분포 (A, B, C, D, E)
   - 심각도 분포 (CRITICAL, HIGH, MEDIUM, LOW)
3. **그래프 통계 features** (10차원):
   - fan_in_count, fan_out_count
   - pattern_score
   - 거래 금액 통계 (log 변환)
   - 그래프 크기
4. **PPR features** (3차원):
   - ppr_score, sdn_ppr, mixer_ppr
5. **정규화 점수** (2차원):
   - n_theta, n_omega
6. **패턴 탐지 여부** (3차원):
   - fan_in_detected, fan_out_detected, gather_scatter_detected

#### ML 모델 예측

학습된 머신러닝 모델(Logistic Regression, Random Forest, Gradient Boosting)이 feature 벡터를 입력받아 Fraud 확률을 예측합니다.

#### 최종 점수 계산

1단계 점수와 ML 예측 점수를 가중 평균하여 최종 점수를 계산합니다:

```
최종 점수 = 0.6 × 1단계 점수 + 0.4 × ML 예측 점수
```

이 가중치는 1단계 점수의 신뢰도를 유지하면서 ML의 보정 효과를 반영하도록 설정되었습니다.

### 8단계: 리스크 레벨 및 태그 생성

#### 리스크 레벨 결정

최종 점수에 따라 리스크 레벨을 결정합니다:

- **Critical**: 80점 이상
- **High**: 60점 이상
- **Medium**: 30점 이상
- **Low**: 30점 미만

#### 리스크 태그 생성

발동된 룰과 탐지된 패턴을 기반으로 태그를 생성합니다:

- `mixer_inflow`: 믹서에서 자금 유입
- `sanction_exposure`: 제재 대상 노출
- `layering_chain`: 레이어링 체인 패턴
- `high_value_transfer`: 고액 거래
- `ml_pattern_fan_in`: ML 패턴 탐지 (Fan-in)

---

## 📊 성능 및 검증

### 데이터셋

- **총 샘플 수**: 92,138개 (Ethereum, 2016-2024)
- **Normal**: 58.1% (53,500개)
- **Fraud**: 41.9% (38,638개)
- **라벨 출처**: Etherscan 주소 태그

### 성능 지표

본 시스템은 다음과 같은 성능을 달성했습니다:

- **Accuracy**: 78.86%
- **F1-Score**: 0.6876
- **ROC-AUC**: 0.8777

이는 단순 Rule-based 모델(Accuracy: 65.2%)이나 순수 ML 모델(Accuracy: 72.1%)보다 우수한 성능입니다.

### 검증 방법

- **Stratified Sampling**: 라벨 분포를 유지하며 데이터 분할
- **Train/Validation/Test Split**: 70% / 15% / 15%
- **Cross-Validation**: 여러 모델 비교 및 최적 모델 선택

---

## 🏗️ 시스템 아키텍처

### 모듈 구조

```
┌─────────────────────────────────────────┐
│         API Layer (Flask)                │
│  - /api/analyze/address                  │
│  - /api/score/transaction                │
│  - /api/hybrid/address                  │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Scoring Engine (Core)              │
│  ┌──────────────────────────────────┐  │
│  │  Stage 1: Rule + Graph Stats    │  │
│  │  - RuleEvaluator                 │  │
│  │  - ImprovedRuleScorer            │  │
│  │  - Graph Statistics              │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  Stage 2: ML Weighting/Ranking   │  │
│  │  - Feature Extraction (30-dim)    │  │
│  │  - ML Model (LR/RF/GB)           │  │
│  │  - Score Combination             │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Aggregation Modules                │
│  - Window Aggregation                   │
│  - Bucket Aggregation                   │
│  - Topology Analysis                    │
│  - PPR Connector                        │
│  - MPOCryptoML Patterns                │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Data Layer                         │
│  - List Loader (SDN, Mixer, etc.)       │
│  - Rule Loader (TRACE-X YAML)          │
│  - Etherscan Client                     │
└─────────────────────────────────────────┘
```

### 데이터 흐름

1. **입력**: 주소 또는 거래 정보
2. **전처리**: 블랙리스트 매칭, 금액 변환
3. **1단계 평가**: 룰 평가 + 그래프 통계
4. **2단계 평가**: ML 기반 점수 조정
5. **출력**: 리스크 점수, 레벨, 태그, 설명

---

## 🎯 활용 시나리오

### 1. 실시간 거래 모니터링

CEX에서 실시간으로 들어오는 거래를 모니터링하고, 위험도가 높은 거래를 즉시 탐지합니다. 기본 스코어링 모드(1-2초)를 사용하여 빠른 의사결정을 지원합니다.

### 2. 주소 기반 수동 분석

의심스러운 주소를 입력하면 해당 주소의 모든 거래 히스토리를 분석하여 종합적인 리스크 평가를 제공합니다. 심층 분석 모드(5-30초)를 사용하여 상세한 패턴 분석을 수행합니다.

### 3. 의심거래 보고서 생성

리스크 점수가 높은 거래들을 자동으로 수집하고, 발동된 룰과 탐지된 패턴을 기반으로 상세한 보고서를 생성합니다.

### 4. 규제 기관 보고

OFAC SDN 리스트와의 연결성, 자금 세탁 패턴 등을 명확하게 문서화하여 규제 기관에 보고할 수 있습니다.

---

## 🔮 향후 개선 방향

### 단기 개선

1. **동적 점수 할당**: 거래 금액에 따른 동적 점수 계산 (B-501 룰)
2. **주소 상태 관리**: 주소의 생성 시점, 활성화 상태 등을 추적 (B-401, B-402 룰)
3. **복합 집계 로직**: 그룹화 및 그룹별 분석 (B-502 룰)

### 중기 개선

1. **성능 최적화**: 대규모 그래프 처리 개선, 캐싱 전략
2. **실시간 스트리밍**: WebSocket 기반 실시간 거래 모니터링
3. **다중 체인 지원**: Ethereum 외 다른 블록체인 지원

### 장기 개선

1. **비지도 학습 통합**: 룰북에 없는 새로운 패턴 자동 탐지
2. **강화 학습**: 룰 가중치 자동 최적화
3. **그래프 임베딩**: 주소의 시계열 패턴을 그래프 임베딩으로 표현

---

## 📚 기술 스택

- **Backend**: Python 3.10+, Flask
- **ML Framework**: scikit-learn, NumPy
- **Graph Analysis**: NetworkX
- **Data Processing**: Pandas, JSON
- **API Documentation**: Swagger/OpenAPI

---

## 📝 결론

본 시스템은 **2단계 하이브리드 아키텍처**, **TRACE-X 룰북 기반 규칙 평가**, **MPOCryptoML 방법론 통합**을 통해 기존 시스템의 한계를 극복하고, 높은 정확도와 해석 가능성을 동시에 달성했습니다. 특히 Rule-based와 ML의 명확한 분리, 그리고 그래프 구조 분석을 통한 복잡한 패턴 탐지는 본 시스템의 핵심 차별성입니다.

CEX를 위한 실용적인 AML 리스크 스코어링 시스템으로, 실시간 모니터링부터 상세 분석까지 다양한 시나리오에서 활용할 수 있으며, 지속적인 개선을 통해 더욱 정확하고 효율적인 시스템으로 발전할 것입니다.
