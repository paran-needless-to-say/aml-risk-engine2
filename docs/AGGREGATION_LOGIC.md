# ì§‘ê³„ ë¡œì§ êµ¬í˜„ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ë£°ë¶ì˜ `window`ì™€ `aggregations`ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì‹œê°„ ê¸°ë°˜ ì§‘ê³„ ë¡œì§ì…ë‹ˆë‹¤.

## ğŸ” ì§‘ê³„ ë¡œì§ì´ í•„ìš”í•œ ì´ìœ 

### ë‹¨ì¼ íŠ¸ëœì­ì…˜ í‰ê°€ì˜ í•œê³„

í˜„ì¬ëŠ” **ë‹¨ì¼ íŠ¸ëœì­ì…˜**ë§Œ í‰ê°€í•˜ì§€ë§Œ, ë§ì€ ë£°ì€ **ì‹œê°„ ìœˆë„ìš° ë‚´ ì—¬ëŸ¬ íŠ¸ëœì­ì…˜**ì„ ì§‘ê³„í•´ì•¼ í•©ë‹ˆë‹¤:

**ì˜ˆì‹œ: C-004 ë£°**

```yaml
- id: "C-004"
  name: "High-Value Repeated Transfer (24h)"
  window:
    duration_sec: 86400 # 24ì‹œê°„
    group_by: ["address"]
  aggregations:
    - sum_gte: { field: "usd_value", value: 10000 } # í•©ê³„ >= 10,000 USD
    - count_gte: { value: 3 } # ê°œìˆ˜ >= 3ê°œ
    - every_gte: { field: "usd_value", value: 3000 } # ëª¨ë“  ê±°ë˜ >= 3,000 USD
```

ì´ ë£°ì€ **24ì‹œê°„ ë‚´ì— 3ë²ˆ ì´ìƒ ê±°ë˜í•˜ê³ , ê° ê±°ë˜ê°€ 3,000 USD ì´ìƒì´ë©°, ì´í•©ì´ 10,000 USD ì´ìƒ**ì¸ ê²½ìš°ë¥¼ íƒì§€í•©ë‹ˆë‹¤.

## ğŸ—ï¸ êµ¬í˜„ ë°©ì‹

### 1. ì‹œê°„ ìœˆë„ìš° ì²˜ë¦¬

```
íŠ¸ëœì­ì…˜ ì‹œí€€ìŠ¤:
[tx1: 10:00, tx2: 10:30, tx3: 11:00, tx4: 12:00, tx5: 13:00]

24ì‹œê°„ ìœˆë„ìš° (10:00 ê¸°ì¤€):
- 10:00 ~ 10:00+24h ë‚´ì˜ ëª¨ë“  íŠ¸ëœì­ì…˜ ìˆ˜ì§‘
- tx1, tx2, tx3, tx4, tx5 ëª¨ë‘ í¬í•¨

ìŠ¬ë¼ì´ë”© ìœˆë„ìš°:
- ê° íŠ¸ëœì­ì…˜ì„ ê¸°ì¤€ìœ¼ë¡œ ìœˆë„ìš° ìƒì„±
- tx1 ê¸°ì¤€: [tx1, tx2, tx3, tx4, tx5]
- tx2 ê¸°ì¤€: [tx2, tx3, tx4, tx5]
- ...
```

### 2. ì§‘ê³„ ì¡°ê±´ í‰ê°€

```python
# ì˜ˆì‹œ: C-004 ë£°
window_txs = [tx1, tx2, tx3]  # 24ì‹œê°„ ë‚´ íŠ¸ëœì­ì…˜

# sum_gte: í•©ê³„ >= 10000
total = sum(tx.usd_value for tx in window_txs)  # 15,000
if total >= 10000: âœ“

# count_gte: ê°œìˆ˜ >= 3
if len(window_txs) >= 3: âœ“

# every_gte: ëª¨ë“  ê±°ë˜ >= 3000
if all(tx.usd_value >= 3000 for tx in window_txs): âœ“

# ëª¨ë“  ì¡°ê±´ ë§Œì¡± â†’ ë£° ë°œë™
```

### 3. ì§‘ê³„ ì—°ì‚°ì ì¢…ë¥˜

| ì—°ì‚°ì         | ì˜ë¯¸              | ì˜ˆì‹œ                         |
| -------------- | ----------------- | ---------------------------- |
| `sum_gte`      | í•©ê³„ >= ê°’        | ì´ ê±°ë˜ì•¡ >= 10,000 USD      |
| `count_gte`    | ê°œìˆ˜ >= ê°’        | ê±°ë˜ íšŸìˆ˜ >= 3               |
| `every_gte`    | ëª¨ë“  ê°’ >= ê°’     | ëª¨ë“  ê±°ë˜ >= 3,000 USD       |
| `distinct_gte` | ê³ ìœ ê°’ ê°œìˆ˜ >= ê°’ | ì„œë¡œ ë‹¤ë¥¸ ì£¼ì†Œ >= 5ê°œ        |
| `any_gte`      | í•˜ë‚˜ë¼ë„ >= ê°’    | ìµœëŒ€ ê±°ë˜ì•¡ >= 1,000,000 USD |
| `avg_gte`      | í‰ê·  >= ê°’        | í‰ê·  ê±°ë˜ì•¡ >= 5,000 USD     |

## ğŸ“Š ë°ì´í„° êµ¬ì¡°

### íŠ¸ëœì­ì…˜ íˆìŠ¤í† ë¦¬ ì €ì¥

```python
# ì£¼ì†Œë³„ íŠ¸ëœì­ì…˜ íˆìŠ¤í† ë¦¬
address_history = {
    "0xabc...": [
        {"timestamp": 1234567890, "usd_value": 5000, "to": "0xdef..."},
        {"timestamp": 1234568000, "usd_value": 4000, "to": "0xghi..."},
        {"timestamp": 1234569000, "usd_value": 3000, "to": "0xjkl..."},
    ]
}
```

### ìœˆë„ìš° ìƒì„±

```python
def get_window_transactions(
    address: str,
    current_timestamp: int,
    duration_sec: int,
    history: Dict[str, List[Dict]]
) -> List[Dict]:
    """ì‹œê°„ ìœˆë„ìš° ë‚´ íŠ¸ëœì­ì…˜ ë°˜í™˜"""
    txs = history.get(address, [])
    window_start = current_timestamp - duration_sec

    return [
        tx for tx in txs
        if window_start <= tx["timestamp"] <= current_timestamp
    ]
```

## ğŸ”„ í‰ê°€ íë¦„

```
1. ìƒˆ íŠ¸ëœì­ì…˜ ë„ì°©
   â†“
2. ì£¼ì†Œë³„ íˆìŠ¤í† ë¦¬ì—ì„œ ìœˆë„ìš° íŠ¸ëœì­ì…˜ ìˆ˜ì§‘
   â†“
3. ê° ë£°ì˜ window/aggregations ì¡°ê±´ í™•ì¸
   â†“
4. ì¡°ê±´ ë§Œì¡± ì‹œ ë£° ë°œë™
   â†“
5. íˆìŠ¤í† ë¦¬ì— ìƒˆ íŠ¸ëœì­ì…˜ ì¶”ê°€
```

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ë©”ëª¨ë¦¬ ê´€ë¦¬**: ì˜¤ë˜ëœ íŠ¸ëœì­ì…˜ì€ ì£¼ê¸°ì ìœ¼ë¡œ ì‚­ì œ
2. **ì„±ëŠ¥**: ìœˆë„ìš° í¬ê¸°ê°€ í¬ë©´ ì„±ëŠ¥ ì €í•˜ (ì¸ë±ì‹± í•„ìš”)
3. **ë™ì‹œì„±**: ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì´ ë™ì‹œì— ì˜¤ë©´ ë½ í•„ìš”
