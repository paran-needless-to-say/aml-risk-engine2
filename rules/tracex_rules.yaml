meta:
  version: "1.0"
  namespace: "TRACE-X"
  description: "Compliance/Exposure/Behavior rulebook v1 (implementation spec)"

defaults:
  currency: "USD"
  fields:
    timestamp: "timestamp"
    from: "from"
    to: "to"
    usd_value: "usd_value"
    token: "token" # optional
    tx_hash: "tx_hash" # optional

rules:
  # -------------------------------
  # C — Compliance
  # -------------------------------
  - id: "C-001"
    name: "Sanction Direct Touch"
    axis: "C"
    severity: "HIGH"
    description: "Direct interaction with SDN list"
    match:
      any:
        - in_list: { field: "from", list: "SDN_LIST" }
        - in_list: { field: "to", list: "SDN_LIST" }
    conditions:
      all:
        - gte: { field: "usd_value", value: 1 }
    exceptions:
      any:
        - tag: { field: "from", key: "CEX_INTERNAL", equals: true }
        - tag: { field: "to", key: "CEX_INTERNAL", equals: true }
    score: 30

  - id: "C-002"
    name: "High-Risk Jurisdiction VASP"
    axis: "C"
    severity: "MEDIUM"
    match:
      any:
        - tag: { field: "counterparty", key: "country", in: ["IR", "RU", "KP"] }
    conditions:
      all:
        - tag: { field: "counterparty", key: "type", equals: "VASP" }
    exceptions:
      any:
        - tag: { field: "counterparty", key: "safe_vasp", equals: true }
    score: 20

  - id: "C-003"
    name: "High-Value Single Transfer"
    axis: "C"
    severity: "MEDIUM"
    conditions:
      all:
        - gte: { field: "usd_value", value: 7000 }
    exceptions:
      any:
        - tag: { field: "from", key: "CEX_INTERNAL", equals: true }
        - tag: { field: "to", key: "CEX_INTERNAL", equals: true }
    score: 20

  - id: "C-004"
    name: "High-Value Repeated Transfer (24h)"
    axis: "C"
    severity: "MEDIUM"
    window:
      duration_sec: 86400
      group_by: ["address"] # evaluated for the target address perspective
    aggregations:
      - sum_gte: { field: "usd_value", value: 10000 }
      - count_gte: { value: 3 }
      - every_gte: { field: "usd_value", value: 3000 }
    exceptions:
      any:
        - tag: { field: "address", key: "MM_BOT", equals: true }
        - tag: { field: "address", key: "CEX_INTERNAL", equals: true }
    score: 20

  # -------------------------------
  # E — Exposure
  # -------------------------------
  - id: "E-101"
    name: "Mixer Direct Exposure"
    axis: "E"
    severity: "HIGH"
    match:
      any:
        - in_list: { field: "from", list: "MIXER_LIST" }
    conditions:
      all:
        - gte: { field: "usd_value", value: 20 }
    exceptions:
      any:
        - tag: { field: "address", key: "REWARD_PAYOUT", equals: true }
    score: 25

  - id: "E-102"
    name: "Indirect Sanctions Exposure (≤2 hops)"
    axis: "E"
    severity: "HIGH"
    match:
      any:
        - in_list: { field: "address", list: "SDN_HOP1" }
        - in_list: { field: "address", list: "SDN_HOP2" }
    conditions:
      all:
        - gte: { field: "usd_value", value: 20 }
    exceptions:
      any:
        - tag: { field: "address", key: "CEX_INTERNAL", equals: true }
    score: 30

  - id: "E-103"
    name: "Counterparty Quality Risk"
    axis: "E"
    severity: "MEDIUM"
    conditions:
      all:
        - gte: { field: "counterparty.risk_score", value: 0.7 }
    score_range: [10, 20]
    score: 15 # default within range

  # -------------------------------
  # B — Behavior
  # -------------------------------
  # TEMPO
  - id: "B-101"
    name: "Burst (10m)"
    axis: "B"
    severity: "MEDIUM"
    window:
      duration_sec: 600
      group_by: ["address"]
      cooldown_sec: 1800
    aggregations:
      - count_gte: { value: 3 }
    exceptions:
      any:
        - tag: { field: "address", key: "CEX_INTERNAL", equals: true }
        - tag: { field: "address", key: "MM_BOT", equals: true }
    score: 15

  - id: "B-102"
    name: "Rapid Sequence (1m)"
    axis: "B"
    severity: "HIGH"
    window:
      duration_sec: 60
      group_by: ["address"]
      cooldown_sec: 900
    aggregations:
      - count_gte: { value: 5 }
    exceptions:
      any:
        - tag: { field: "address", key: "CEX_INTERNAL", equals: true }
        - tag: { field: "address", key: "MM_BOT", equals: true }
    score: 20

  - id: "B-103"
    name: "Inter-arrival Std High"
    axis: "B"
    severity: "LOW"
    prerequisites:
      - min_edges: 10
    conditions:
      all:
        - gte: { field: "interarrival_std", value: 2.0 }
        - gte: { field: "usd_value", value: 50 }
    score: 10

  # TOPOLOGY (requires token dimension)
  - id: "B-201"
    name: "Layering Chain (same token)"
    axis: "B"
    severity: "HIGH"
    topology:
      same_token: true
      hop_length_gte: 3
      hop_amount_delta_pct_lte: 5
      min_usd_value: 100
    score: 25

  - id: "B-202"
    name: "Cycle (length 2-3, same token)"
    axis: "B"
    severity: "HIGH"
    topology:
      same_token: true
      cycle_length_in: [2, 3]
      cycle_total_usd_gte: 100
    score: 30

  - id: "B-203"
    name: "Fan-out (10m bucket)"
    axis: "B"
    severity: "MEDIUM"
    bucket:
      size_sec: 600
      group: ["chain_id", "token", "from", "bucket_10m"]
    aggregations:
      - distinct_gte: { field: "to", value: 5 }
      - sum_gte: { field: "usd_value", value: 1000 }
      - every_gte: { field: "usd_value", value: 100 }
    score: 20

  - id: "B-204"
    name: "Fan-in (10m bucket)"
    axis: "B"
    severity: "MEDIUM"
    bucket:
      size_sec: 600
      group: ["chain_id", "token", "to", "bucket_10m"]
    aggregations:
      - distinct_gte: { field: "from", value: 5 }
      - sum_gte: { field: "usd_value", value: 1000 }
      - every_gte: { field: "usd_value", value: 100 }
    score: 20

  # LIFECYCLE
  - id: "B-401"
    name: "First 7 Days Burst"
    axis: "B"
    severity: "MEDIUM"
    state:
      required: ["first_seen_ts", "first7d_usd", "first7d_tx_count"]
    conditions:
      all:
        - lte: { field: "age_days", value: 7 }
        - gte: { field: "first7d_usd", value: 10000 }
        - gte: { field: "first7d_tx_count", value: 3 }
    score: 20

  - id: "B-402"
    name: "Reactivation"
    axis: "B"
    severity: "LOW"
    state:
      required: ["first_seen_ts", "last_seen_ts"]
    conditions:
      all:
        - gte: { field: "age_days", value: 365 }
        - gte: { field: "inactive_days", value: 180 }
        - gte: { field: "usd_value", value: 1000 }
    score: 15

  - id: "B-403A"
    name: "Lifecycle A — Young but Busy"
    axis: "B"
    severity: "LOW"
    conditions:
      all:
        - lte: { field: "age_days", value: 30 }
        - gte: { field: "tx_count_30d", value: 100 }
        - gte: { field: "median_usd_30d", value: 100 }
    score: 10

  - id: "B-403B"
    name: "Lifecycle B — Old and Rare High Value"
    axis: "B"
    severity: "LOW"
    conditions:
      all:
        - gte: { field: "age_days", value: 365 }
        - lte: { field: "tx_count_total", value: 10 }
        - gte: { field: "total_usd_total", value: 50000 }
        - gte: { field: "median_usd_total", value: 5000 }
    score: 10

  # VALUE
  - id: "B-501"
    name: "High-Value Buckets"
    axis: "B"
    severity: "MEDIUM"
    buckets:
      field: "usd_value"
      ranges:
        - { min: 10000, max: 50000, score: 5 }
        - { min: 50000, max: 250000, score: 10 }
        - { min: 250000, max: 1000000, score: 15 }
        - { min: 1000000, score: 20 }
    score: dynamic

  - id: "B-502"
    name: "Structuring — Rounded Value Repetition (24h outgoing)"
    axis: "B"
    severity: "LOW"
    window:
      duration_sec: 86400
      group_by: ["address", "direction:outgoing"]
    aggregations:
      - any_gte: { field: "usd_value", value: 10000000 } # allows KRW scale if needed
      - group_by_value: "rounded_value"
      - per_group:
          - count_gte: { value: 5 }
          - sum_gte: { field: "usd_value", value: 10000 }
    score: 10
